---
title: "catchability ms analysis"
output: html_document
date: "2024-04-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, wdnr.fmdb, wdnr.gis, lubridate, here, lme4, glmmTMB, DHARMa, emmeans, effects, AUC)

```



```{r}
fishscapes.pe<-read_csv(here::here("data","fishscapes.cpue.pe.ef.cpe.csv"))%>%
  filter(!is.na(pop.density))

fishscapes.ef.cpe<-read_csv(here::here("data","fishscapes.cpue.pe.ef.cpe.csv"))%>%
  filter(!is.na(efCPE))

fishscapes.full<-read_csv(here::here("data","fishscapes.cpue.pe.ef.cpe.csv"))

all_equal(fishscapes.pe, fishscapes.ef.cpe)
# good; just need the one


fishscapes<-fishscapes.pe%>%
  mutate(cpue=anCPUE,
         ln.cpue=log(cpue+0.01),
         month=month(date))%>%
  rename("wbic"=WBIC,
         "ef.cpe"=efCPE)%>%
  mutate(wbic=as.factor(wbic),
         year=as.factor(year),
         month=as.factor(month))
  

ggplot(fishscapes)+
  geom_point(aes(x=pop.density, y=cpue))+
  theme_bw()


ggplot(fishscapes)+
  geom_point(aes(x=ln.pop.density, y=ln.cpue))

hist(as.numeric(fishscapes$month))
```
Fewer months than dnr data; could still use month or day of year

instead of date random effect and month as a fixed effect, adding day of year as quadratic fixed effect.
date will still be tested as a random effect in some models

previous convergence problems (and mismatch with previous models) was caused by year being numeric instead of a factor. silly goose.

```{r}

mod.null.lmb.pe<-glmmTMB(cpue~ln.pop.density + year, 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2 +year)


mod.lakeID.lmb.pe<-glmmTMB(cpue~ln.pop.density + year +(1|lakeID) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2 +year+(1|lakeID))



mod.caughtBy.lmb.pe<-glmmTMB(cpue~ln.pop.density + year +(1|caughtBy) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2 +year+(1|caughtBy))

mod.date.lmb.pe<-glmmTMB(cpue~ln.pop.density +  year +(1|date) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2 +year+(1|date))

mod.lakeID.caughtBy.lmb.pe<-glmmTMB(cpue~ln.pop.density + year+(1|lakeID)+(1|caughtBy), 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2 +year+(1|lakeID)+(1|caughtBy) )

mod.lakeID.date.lmb.pe<-glmmTMB(cpue~ln.pop.density + year+(1|lakeID)+(1|date) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|lakeID)+(1|date))

mod.caughtBy.date.lmb.pe<-glmmTMB(cpue~ln.pop.density +year+(1|caughtBy)+(1|date) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|caughtBy)+(1|date))

mod.lakeID.caughtBy.date.lmb.pe<-glmmTMB(cpue~ln.pop.density +year+(1|lakeID)+(1|date)+(1|caughtBy) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2+year+(1|lakeID)+(1|date)+(1|caughtBy) )

AIC(mod.null.lmb.pe, mod.lakeID.lmb.pe, mod.caughtBy.lmb.pe, mod.date.lmb.pe, mod.lakeID.caughtBy.lmb.pe, mod.lakeID.date.lmb.pe, mod.caughtBy.date.lmb.pe, mod.lakeID.caughtBy.date.lmb.pe )

sim.resid<-simulateResiduals(mod.caughtBy.date.lmb.pe)
plot(sim.resid)

mod.fs.pe<-mod.caughtBy.date.lmb.pe
```

Interesting; caughtBy and date random effects are best fits; does not include wbic!

```{r}
summary(mod.fs.pe)
performance::r2(mod.fs.pe)
performance::r2_zeroinflated(mod.fs.pe)
```
```{r}
ranef<-ranef(mod.fs.pe)

caughtBy<-ranef$zi$caughtBy
mean(caughtBy$`(Intercept)`)
sd(caughtBy$`(Intercept)`)


mean(ranef$zi$date$`(Intercept)`)
sd(ranef$zi$date$`(Intercept)`)
```



higher, but not incredible r2. 

Closer look at variance explained

```{r}
# full model
sd.response<-sd(fishscapes$cpue)
var.response<-sd.response^2

predictions<-predict(mod.fs.pe, type="response")
sd.pred<-sd(predictions)
var.pred<-sd.pred^2

# null model
# I'm calling model with only fixed effects the null model here
mod.null.lmb.pe<-glmmTMB(cpue~ln.pop.density + year, 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density+ sc.doy + sc.doy2 +year)

predictions.null<-predict(mod.null.lmb.pe)
var.pred.null<-var(predictions.null)

predictions.date.only<-predict(mod.date.lmb.pe)
var.pred.date.only<-var(predictions.date.only)

predictions.caughtBy.only<-predict(mod.caughtBy.lmb.pe)
var.pred.caughtBy.only<-var(predictions.caughtBy.only)
```

look specifically at binomial model and lognormal random effects separately--i think the combined hurdle model r2 outputs are obscuring stuff

```{r}
mod.caughtBy.date.lmb.pe.zi<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|caughtBy)+(1|date))
summary(mod.caughtBy.date.lmb.pe.zi)

performance::r2_zeroinflated(mod.caughtBy.date.lmb.pe.zi)

mod.caughtBy.date.lmb.pe.zi.fixed<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year)
performance::r2_zeroinflated(mod.caughtBy.date.lmb.pe.zi.fixed)

mod.caughtBy.date.lmb.pe.zi.angler<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|caughtBy))
performance::r2_zeroinflated(mod.caughtBy.date.lmb.pe.zi.angler)

mod.caughtBy.date.lmb.pe.zi.date<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|date))
performance::r2_zeroinflated(mod.caughtBy.date.lmb.pe.zi.date)


```
Now the same but without fixed effects

```{r}
mod.zi.full<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year + (1|caughtBy) + (1|date))
performance::r2_zeroinflated(mod.zi.full)

mod.zi.fixed.only<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year)
performance::r2_zeroinflated(mod.zi.fixed.only)

mod.zi.random.only<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~1+(1|caughtBy) + (1|date))
performance::r2_zeroinflated(mod.zi.random.only)

mod.zi.caughtBy.only<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~1+(1|caughtBy) )
performance::r2_zeroinflated(mod.zi.caughtBy.only)

mod.zi.date.only<-glmmTMB(cpue~1 , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~1+ (1|date))
performance::r2_zeroinflated(mod.zi.date.only)


```



r2 for zero model only is 0.18

```{r}
fishscapes.no.0<-filter(fishscapes, cpue!=0)

mod.caughtBy.date.lmb.pe.conditional<-glmmTMB(cpue~ln.pop.density +year+(1|caughtBy)+(1|date) , 
                  data=fishscapes.no.0, family=glmmTMB::lognormal(link="log"))
summary(mod.caughtBy.date.lmb.pe.conditional)
performance::r2(mod.caughtBy.date.lmb.pe.conditional)

```
```{r}
mod.caughtBy.date.lmb.pe.conditional.null<-glmmTMB(cpue~ln.pop.density +year, 
                  data=fishscapes.no.0, family=glmmTMB::lognormal(link="log"))
summary(mod.caughtBy.date.lmb.pe.conditional.null)
performance::r2(mod.caughtBy.date.lmb.pe.conditional.null)

```
```{r}
mod.caughtBy.date.lmb.pe.conditional.caughtBy<-glmmTMB(cpue~ln.pop.density +year+(1|caughtBy), 
                  data=fishscapes.no.0, family=glmmTMB::lognormal(link="log"))
summary(mod.caughtBy.date.lmb.pe.conditional.caughtBy)
performance::r2(mod.caughtBy.date.lmb.pe.conditional.caughtBy)

```
```{r}
mod.caughtBy.date.lmb.pe.conditional.date<-glmmTMB(cpue~ln.pop.density +year+(1|date), 
                  data=fishscapes.no.0, family=glmmTMB::lognormal(link="log"))
summary(mod.caughtBy.date.lmb.pe.conditional.date)
performance::r2(mod.caughtBy.date.lmb.pe.conditional.date)

```

```{r}
mod.fs.pe<-glmmTMB(cpue~ln.pop.density +year+(1|caughtBy)+(1|date) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|caughtBy)+(1|date))
mod.fs.pe.date<-glmmTMB(cpue~ln.pop.density +year+(1|date) , 
                  data=fishscapes, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + sc.doy + sc.doy2+year+(1|date))

```

```{r}
fishscapes$mod.pred<-predict(mod.fs.pe, type="response")
fishscapes$mod.pred.noCaughtBy<-predict(mod.fs.pe.date, type="response")

ggplot(fishscapes)+
  geom_point(aes(x=pop.density, y=cpue))+
  geom_point(aes(x=pop.density, y=mod.pred), color="red")+
 # geom_point(aes(x=pop.density, y=mod.pred.noCaughtBy), color="blue")+
  theme_bw()
```


Now look closer at values of random intercepts

```{r}
random<-ranef(mod.fs.pe)
zi.random<-random$zi
cond.random<-random$cond

zi.day.effect<-zi.random$date
zi.day.effect$date<-rownames(zi.day.effect)
zi.day.effect$intercept<-exp(zi.day.effect$`(Intercept)`)/(1+exp(zi.day.effect$`(Intercept)`))

ggplot(zi.day.effect)+
  geom_point(aes(x=date, y=intercept))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90))
ggsave(here::here("figures","fishscapes","zi.date.effect.png"), height=4, width=6)


zi.angler.effect<-zi.random$caughtBy
zi.angler.effect$caughtBy<-rownames(zi.angler.effect)
zi.angler.effect$intercept<-exp(zi.angler.effect$`(Intercept)`)/(1+exp(zi.angler.effect$`(Intercept)`))

ggplot(zi.angler.effect)+
  geom_point(aes(x=caughtBy, y=intercept))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90))
ggsave(here::here("figures","fishscapes","zi.angler.effect.png"), height=4, width=6)

```

```{r}
cond.day.effect<-cond.random$date
cond.day.effect$date<-rownames(cond.day.effect)
cond.day.effect$intercept<-cond.day.effect$`(Intercept)`

ggplot(cond.day.effect)+
  geom_point(aes(x=date, y=exp(intercept)))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90))
ggsave(here::here("figures","fishscapes","cond.date.effect.png"), height=4, width=6)


cond.angler.effect<-cond.random$caughtBy
cond.angler.effect$caughtBy<-rownames(cond.angler.effect)
cond.angler.effect$intercept<-cond.angler.effect$`(Intercept)`

ggplot(cond.angler.effect)+
  geom_point(aes(x=caughtBy, y=exp(intercept)))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90))
ggsave(here::here("figures","fishscapes","cond.angler.effect.png"), height=4, width=6)

```
