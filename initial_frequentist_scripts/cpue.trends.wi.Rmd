---
title: "cpue trends wi"
output: html_document
date: "2024-04-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, here, wdnr.fmdb)
```

Producing plots displaying trends of catch rates for  LMB, bluegill, and walleye
(also targeted effort?)

Start with fishery independent cpue

No need to run this again; output files are now saved under data.fmdb
```{r}
# is there a survey_seq value for AC electrofishing surveys? (or springtime surveys in general?)
surveys<-get_fmdb_surveys()%>%
  filter(primary.survey.purpose%in%c("fisheries_assessments_lakes_early_spring_wae_mue","fisheries_assessments_lakes_late_spring_bass_pan"))

surveys<-filter(surveys, survey.status!="data_entry_not_complete")
surveyID<-surveys$survey.seq.no

electro_effort<-get_fmdb_efforts(survey_seq=surveyID[1:96])
#electro_effort2<-get_fmdb_efforts(survey_seq=surveyID[98:194])

sequence<-seq(97, 4608, by=96)


for(i in seq_along(sequence)){
  electro_effort<-rbind.data.frame(electro_effort,
                      get_fmdb_efforts(survey_seq=surveyID[sequence[i]:sequence[(i+1)]]))
  print(i)
}

electro_effort2<-rbind.data.frame(electro_effort,
                                   get_fmdb_efforts(survey_seq=surveyID[4500:4596]))
electro_effort3<-rbind.data.frame(electro_effort2, get_fmdb_efforts(survey_seq=surveyID[4597:4637]))

electro_effort<-rbind.data.frame(electro_effort, electro_effort2, electro_effort3)%>%
  filter(gear=="boom_shocker")

write.csv(electro_effort, here::here("data.fmdb","electro.effort.csv"))

#3242 unique survey.seq.no

survey_seq=unique(electro_effort$survey.seq.no)

sequence<-seq(97, 3168, by=96)


fishraw<-get_fmdb_fishraw(survey_seq=survey_seq[1:97], spp=c("bluegill","walleye","largemouth bass"))

# next time, write out each chunk and clear the df
for(i in seq_along(sequence)){
  fishraw<-rbind.data.frame(fishraw,
                      get_fmdb_fishraw(survey_seq=survey_seq[sequence[i]:sequence[(i+1)]]))
  print(i)
}

fishraw2<-get_fmdb_fishraw(survey_seq=survey_seq[3066:3162])
fishraw3<-get_fmdb_fishraw(survey_seq=survey_seq[3163:3242])

fishraw<-rbind.data.frame(fishraw, fishraw2, fishraw3)
# fishraw2<-rbind.data.frame(fishraw, get_fmdb_fishraw(survey_seq=survey_seq[3162:3200]))
# fishraw3<-rbind.data.frame(fishraw, get_fmdb_fishraw(survey_seq=survey_seq[3201:3242]))


fishraw<-fishraw3

write.csv(fishraw,  here::here("data.fmdb", "fishraw.electro.lmb.blg.wae.csv"))
write.csv(electro_effort, here::here("data.fmdb","effort.electro.csv"))
```


```{r}
electro_effort<-read_csv(here::here("data.fmdb","electro.effort.csv"))
electro_effort<-electro_effort[,-1]
fishraw<-read_csv(here::here("data.fmdb","fishraw.electro.lmb.blg.wae.csv"))
fishraw<-fishraw[,-1]
```
Now estimate electrofishing catch rates (fish/km shoreline) 

```{r}
fishraw_electro<-fishraw%>%
  filter(gear=="boom_shocker")%>%
  filter(species%in%c("largemouth_bass","walleye","bluegill"))%>%
  mutate(swims.station.id=as.character(swims.station.id))

electro_effort$swims.station.id<-as.character(electro_effort$swims.station.id)

electro_cpe<-calc_cpe(electro_effort, fishraw_electro)
write.csv(electro_cpe, here::here("data.fmdb","electro.cpe.lmb.blg.wae.csv"))

#electro_cpe<-read_csv(here::here("data.fmdb","electro.cpe.lmb.blg.wae.csv"))
#electro_cpe<-electro_cpe[,-1]
```
And plot the trends--color by lake

```{r}
electro_cpe_plot<-electro_cpe%>%
  mutate(effort_km=1.61*total_effort,
         cpe_km=total_catch/effort_km)%>%
  filter(year>2000)

nYears<-electro_cpe_plot%>%
  group_by(wbic)%>%
  summarize(nYears=length(unique(year)))%>%
  filter(nYears>5)

electro_cpe_plot_trend<-filter(electro_cpe_plot, wbic%in%nYears$wbic)%>%
  mutate(wbic=as.factor(wbic))

# here is cpue for all lakes and all years
```


```{r}
ggplot(electro_cpe_plot)+
  geom_point(aes(x=year, y=cpe_km))+
  facet_grid(.~species)+
  theme_bw()
```
Now trend lakes only

```{r}

palette<-c("#a0e3b7", "#255026", "#ade64f", "#04a38f", "#38f0ac", "#294775", "#8c88d7", "#a335c8", "#e18af4", "#782857", "#4ea6dc", "#4f42ab", "#eec8f1", "#fd048f", "#fe16f4", "#2524f9", "#54a32f", "#24e53d", "#7c8869", "#ead624", "#743502", "#fca283", "#d5082d", "#f79302", "#ecd292", "black","gray","tan")
ggplot(electro_cpe_plot_trend)+
  geom_point(aes(x=year, y=log(cpe_km), color=wbic))+
  scale_color_manual(values=palette)+
  geom_smooth(method="lm", aes(x=year, y=log(cpe_km), group=wbic, color=wbic), se=F)+
  facet_grid(.~species)+
  theme_bw()+
  theme(legend.position="none")
ggsave(here::here("figures","dnr.electro.mean.catch.trend.png"), height=4, width=10)
```
http://vrl.cs.brown.edu/color for color palette

Then fishery dependent cpue and targeted effort

```{r}
creelCheck<-creel_catch%>%
  group_by(wbic, year)%>%
  mutate(sum.hours=sum(total.spp.hours))%>%
  ungroup()%>%
  mutate(prop.hours=total.spp.hours/sum.hours)
  
```


```{r}
wbics<-nYears$wbic

creel_fish<-get_creel_fish_data(wbic=wbics)
creel_catch<-calc_creel_harvest_rates(creel_fish, grouping=c("year","wbic"))
  filter(species%in%c("largemouth_bass","bluegill","walleye"))%>%
  mutate(wbic=as.factor(wbic))

ggplot(creel_catch)+
  geom_point(aes(x=year, y=log(spp.catch.rate), color=wbic))+
  scale_color_manual(values=palette)+
  geom_smooth(method="lm", aes(x=year, y=log(spp.catch.rate), group=wbic, color=wbic), se=F)+
  facet_grid(.~species)+
  theme_bw()+
  theme(legend.position="none")

```
And fishign effort

```{r}
creel_counts<-get_creel_counts(wbic=wbics)
creel_int<-get_creel_int_party(wbic=wbics)

creel_eff<-calc_creel_effort(creel_counts, creel_int)

creel_eff_sum<-sum_monthly_creel_effort(creel_counts, creel_int)%>%
  group_by(year, wbic)%>%
  summarize(annualEffort=sum(total.effort))

creel_eff_prop<-creel_catch%>%
  filter(species%in%c("bluegill","largemouth_bass","walleye"))%>%
  left_join(creel_eff_sum, by=c("wbic","year"))%>%
  mutate(spp.effort=spp.prop*annualEffort,
         wbic=as.factor(wbic))



ggplot(creel_eff_prop)+
  geom_point(aes(x=year, y=spp.effort, color=wbic))+
  scale_color_manual(values=palette)+
  geom_smooth(method="lm", aes(x=year, y=spp.effort, group=wbic, color=wbic), se=F)+
  facet_grid(.~species, scales="free")+
  theme_bw()+
  theme(legend.position="none")

```

Can I use prop.spp to estimate species specific fishign effort?