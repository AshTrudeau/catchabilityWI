---
title: "trip catchability"
output: html_document
date: "2024-03-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, wdnr.fmdb, wdnr.gis, lubridate, here, lme4, glmmTMB, DHARMa, bblme, emmeans, effects)

```

```{r}
data<-read_csv(here::here("data","indiv.level.cpue.pe.csv"))%>%
  # more aggressively filtering positive outliers--I really don't believe that anglers are catching more than 10 walleye/hour
  filter(cpue<20 & !is.na(pe))%>%
  mutate(ln.cpue=log(cpue+0.01),
         ln.pop.density=log(pop.density+0.01),
         wbic=as.factor(wbic))%>%
  mutate(sample.date=ymd(sample.date),
         year=as.factor(year(sample.date)),
         month=as.factor(month(sample.date)),
         sample.date=as.factor(sample.date))
  

mod.indiv<-lmer(ln.cpue~ln.pop.density + (1|wbic) + (1|year), data=data)
plot(mod.indiv)
# no, this is kind of fucked. Going to need a hurdle or zero inflation model (which will be even more helpful for fishscapes LMB catchability)

# Shaw et al 2021 use a hurdle model and linearized catch equation with glmmTMB

```

```{r}
ggplot(data)+
  geom_histogram(aes(cpue))+
  theme_bw()

ggsave(here::here("figures","wdnr","cpue.hist.png"), height=4, width=6)

ggplot(data)+
  geom_histogram(aes(pop.density))+
  theme_bw()
ggsave(here::here("figures","wdnr","pop.density.hist.png"), height=4, width=6)
```

```{r}
ggplot(data)+
  geom_point(aes(x=pop.density, y=cpue))+
  theme_bw()
ggsave(here::here("figures","wdnr","cpue.pop.png"), height=4, width=6)

ggplot(data)+
  geom_point(aes(x=ln.pop.density, y=ln.cpue))+
  theme_bw()
ggsave(here::here("figures","wdnr","lncpue.lnpop.png"), height=4, width=6)

```

examples here: https://www.biorxiv.org/content/biorxiv/suppl/2017/05/01/132753.DC1/132753-2.pdf 
lognormal hurdle model here https://github.com/glmmTMB/glmmTMB/issues/677 
more info https://glmmtmb.github.io/glmmTMB/ 
model evaluation https://cran.r-project.org/web/packages/glmmTMB/vignettes/model_evaluation.pdf 

need dev version

something odd is happening with the DHARMa output--maybe the very large sample size? I'm going to subsample
the data to see if anything changes


```{r}
data.red<-data[sample(nrow(data), 5000),]

mod.hurd<-glmmTMB(cpue~ln.pop.density+(1|wbic) , 
                  data=data.red, family=glmmTMB::lognormal(link="log"), ziformula=~ln.pop.density+(1|wbic))


sim.res<-simulateResiduals(mod.hurd)
testDispersion(sim.res)
plot(sim.res)
plotResiduals(sim.res, form=data.red$ln.pop.density)

hist(sim.res)
```

I can fit the model, and it doesn't look totally mis-specified. (large sample size makes DHARMa hard to use..)

Let's do some model selection to test variance structures

In both conditional and zero inflated model: 
mod.0- Null model
mod.1- random intercept by lake
mod.2- random intercepts by lake and year
mod.3- random intercepts by lake, year, and day

```{r}

mod.0<-glmmTMB(cpue~ln.pop.density + month, 
                  data=data, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + month)

mod.1<-glmmTMB(cpue~ln.pop.density + month+(1|wbic) , 
                  data=data, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + month+(1|wbic))

mod.2<-glmmTMB(cpue~ln.pop.density + month+(1|wbic)+(1|year) , 
                  data=data, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density + month+(1|wbic)+(1|year))
mod.3<-glmmTMB(cpue~ln.pop.density + month+(1|wbic)+(1|year)+(1|sample.date) , 
                  data=data, family=glmmTMB::lognormal(link="log"),
               ziformula=~ln.pop.density +
                 month+(1|wbic)+(1|year)+(1|sample.date))


AIC(mod.0, mod.1, mod.2, mod.3)

# mod.3 is lowest AIC

summary(mod.3)
performance::r2(mod.3)
performance::r2_zeroinflated(mod.3)
```


look at random effects

```{r}
rand.ef<-glmmTMB::ranef(mod.3)

zi.lake.effect<-rand.ef$zi$wbic
zi.lake.effect$odds<-exp(zi.lake.effect$`(Intercept)`)
zi.lake.effect$prob<-exp(zi.lake.effect$`(Intercept)`)/(1+exp(zi.lake.effect$`(Intercept)`))


hist(zi.lake.effect$prob)
```


```{r}
sim.resid<-simulateResiduals(mod.3)

plot(sim.resid)
```

adding population density and time of day as fixed effects. I have locations, date, and time, so there may be a simple way to get this. 

This may help https://search.r-project.org/CRAN/refmans/chillR/html/daylength.html 
sunrise and sunset times https://search.r-project.org/CRAN/refmans/bioRad/html/sunrise_sunset.html 

sun angle https://www.rdocumentation.org/packages/oce/versions/0.1-82/topics/sun.angle 
more sun angles but maybe not what I need https://search.r-project.org/CRAN/refmans/fishmethods/html/astrocalc4r.html 

Adding fixed effects: 
- Month
- Time of day (quadratic? sine? categorical dawn/dusk/day/night?) leaning towards categorical--complex cyclic pattern otherwise
  Note: Test daily random effect once month is included--still needed when seasonality is accounted for?
  
Add population estimate

```{r}
mod.pe<-glmmTMB(cpue~ln.pop.density+(1|wbic)+(1|year)+(1|sample.date) , 
                  data=data, family=glmmTMB::lognormal(link="log"),
                  ziformula=~ln.pop.density+(1|wbic)+(1|year)+(1|sample.date))

emmeans(mod.pe, ~ln.pop.density, type="response")

sim.res<-simulateResiduals(mod.pe)
plot(sim.res)

data.red<-data[sample(nrow(data), 10000),]
mod.pe.red<-glmmTMB(cpue~ln.pop.density+(1|wbic)+(1|year)+(1|sample.date) , 
                  data=data.red, family=glmmTMB::lognormal(link="log"),
                  ziformula=~ln.pop.density+(1|wbic)+(1|year)+(1|sample.date))
sim.resid<-simulateResiduals(mod.pe.red, plot=T)

plotResiduals(sim.resid, form=data.red$ln.pop.density)


```




```{r}


mod.pe.month<-glmmTMB(cpue~ln.pop.density+month+(1|wbic)+(1|year)+(1|sample.date) , 
                  data=data, family=glmmTMB::lognormal(link="log"),
                  ziformula=~ln.pop.density+month+(1|wbic)+(1|year)+(1|sample.date))

summary(mod.pe.month)
performance::r2(mod.pe.month)
performance::r2_zeroinflated(mod.pe.month)
# try without sample date

mod.month.no.day<-glmmTMB(cpue~month+(1|wbic)+(1|year) , 
                  data=data, family=glmmTMB::lognormal(link="log"),
                  ziformula=~month+(1|wbic)+(1|year))

AIC(mod.month, mod.month.no.day)




effects<-glmmTMB::allEffects(data$month, mod.month)
plot(effects)

emmeans(mod.month, ~month, type="response")


# slice dataset to test residuals


```
including date random effect is still better fit. Can I get a look at r2?   

Assuming I can trust r2 outputs, (but I think I can), model explains very little variance. This could be a results of just high stochasticity, or individual variation in angler ability. It may help to look at fishscapes angling data, where repeated observations are available for individual anglers. 

Real quick, let's visualize the model fit

```{r}
sim<-simulate(mod.3, seed=32)

sim.data<-data
sim.data$sim.cpue<-sim[[1]]

ggplot(sim.data)+
  geom_point(aes(x=pop.density, y=cpue))+
  geom_point(aes(x=pop.density, y=sim.cpue), color="red", alpha=0.5)+
  theme_bw()
ggsave(here::here("figures","wdnr","model.simulation.png"), height=4, width=6)
```

```{r}
pred<-predict(mod.3, type="response")
pred.data<-data
pred.data$pred<-pred

ggplot(pred.data)+
  geom_point(aes(x=pop.density, y=cpue))+
  geom_point(aes(x=pop.density, y=pred), color="red", alpha=0.5)+
  theme_bw()
ggsave(here::here("figures","wdnr", "model.predictions.png"), height=4, width=6)

ggplot(pred.data)+
  geom_histogram(aes(cpue))+
  geom_histogram(aes(pred), fill="red", alpha=0.5)+
  theme_bw()

ggsave(here::here("figures","wdnr","hist.model.predictions.png"), height=4, width=6)
```


```{r}
ggplot(sim.data, aes(x=cpue, y=sim.cpue))+
  geom_point()+
  geom_abline(slope=1, intercept=0)
```
```{r}
ggplot(sim.data)+
  geom_histogram(aes(cpue), fill="blue")+
  geom_histogram(aes(sim.cpue), fill="red", alpha=0.5)
```

