---
title: "dataVis"
output: html_document
date: "2024-03-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, wdnr.fmdb, wdnr.gis, lubridate, here)
```

Let's start with lakes that have PEs for walleye
browseVignettes("wdnr.fmdb")

```{r}
wye.pe<-read_csv(here::here("data","popest2023.csv"))%>%
  dplyr::select(WBIC:Year)%>%
  filter(Model%in%c(0:4))%>%
  rename("wbic"=WBIC,
         "year"=Year)

wbics<-unique(wye.pe$wbic)

lakeChar<-get_fmdb_lakechar()%>%
  filter(wbic%in%wbics)

creel_counts<-get_creel_counts(wbic=wbics[1:100])
creel_counts2<-get_creel_counts(wbic=wbics[101:200])
creel_counts3<-get_creel_counts(wbic=wbics[201:300])
creel_counts4<-get_creel_counts(wbic=wbics[301:411])

all_counts<-rbind.data.frame(creel_counts, creel_counts2, creel_counts3, creel_counts4)
creel_eff<-sum_monthly_creel_effort(all_counts)

creel_fish<-get_creel_fish_data(wbic=wbics[1:100])
creel_fish2<-get_creel_fish_data(wbic=wbics[101:200])
creel_fish3<-get_creel_fish_data(wbic=wbics[201:300])
creel_fish4<-get_creel_fish_data(wbic=wbics[301:411])

all_fish<-rbind.data.frame(creel_fish, creel_fish2, creel_fish3, creel_fish4)

creel_harv_year<-calc_creel_harvest_rates(all_fish, grouping=c("year","wbic"))
creel_harv_month<-calc_creel_harvest_rates(all_fish, grouping=c("year","month","wbic"))

# output includes total catch rate, directed catch rate, and mean (+ same for harvest)

harv_year_wye<-creel_harv_year%>%
  filter(species=="walleye")%>%
  dplyr::select(year, wbic, spp.catch.rate, spp.harvest.rate, catch.rate.var, harvest.rate.var, total.spp.hours, total.spp.catch)%>%
  left_join(wye.pe, by=c("wbic","year"))%>%
  left_join(lakeChar[,c("wbic","lat","long","lake.area","wae.code")], by="wbic")%>%
  mutate(wye.pop.density=pe/lake.area,
         wbic=as.factor(wbic))
```

plot annual PE vs targeted catch rate

```{r}
ggplot(harv_year_wye, aes(x=log(wye.pop.density), y=log(spp.catch.rate+.01)))+
  geom_point(aes(color=wbic))+
  geom_smooth(method="lm")+
  theme(legend.position="none")

write.csv(harv_year_wye, here::here("data","pe.cpue.walleye.csv"))
```

How many obs per lake?

```{r}
nYears<-harv_year_wye%>%
  group_by(wbic)%>%
  summarize(nYears=length(unique(year)))%>%
  filter(nYears>3)
```

```{r}
mult_years<-harv_year_wye%>%
  filter(wbic%in%nYears$wbic)

ggplot(mult_years, aes(x=wye.pop.density, y=spp.catch.rate))+
  geom_point(aes(color=wbic))+
  geom_smooth(method="loess")+
  theme(legend.position="none")

  
```


Now look by month

```{r}
harv_month_wye<-creel_harv_month%>%
  filter(species=="walleye")%>%
  dplyr::select(year, month, wbic, spp.catch.rate, spp.harvest.rate, catch.rate.var, harvest.rate.var, total.spp.hours, total.spp.catch)%>%
  left_join(wye.pe, by=c("wbic","year"))%>%
  left_join(lakeChar[,c("wbic","lat","long","lake.area","wae.code")], by="wbic")%>%
  mutate(wye.pop.density=pe/lake.area,
         wbic=as.factor(wbic))

ggplot(harv_month_wye, aes(x=month, y=spp.catch.rate))+
  geom_point(aes(color=wbic))+
  theme(legend.position="none")

```

